<view class="container">
  <view class="header">
    <text class="title">ç§¯åˆ†å…‘æ¢</text>
    <text class="subtitle">é€‰æ‹©äººå‘˜å’Œå•†å“è¿›è¡Œå…‘æ¢</text>
  </view>

  <!-- äººå‘˜é€‰æ‹©åŒº -->
  <view class="section">
    <view class="section-title">1. é€‰æ‹©äººå‘˜</view>
    
    <view class="form-item">
      <text class="label">äººå‘˜ç±»å‹</text>
      <view class="radio-group">
        <view class="radio {{selectedType === 'helper' ? 'active' : ''}}" bindtap="selectType" data-type="helper">æŠ¤å·¥</view>
        <view class="radio {{selectedType === 'elderly' ? 'active' : ''}}" bindtap="selectType" data-type="elderly">è€äºº</view>
      </view>
    </view>

    <view class="form-item" wx:if="{{selectedType}}">
      <text class="label">é€‰æ‹©äººå‘˜</text>
      <picker mode="selector" range="{{persons}}" range-key="displayName" bindchange="onPersonChange">
        <view class="picker {{selectedPerson ? '' : 'placeholder'}}">
          {{selectedPerson ? selectedPerson.name + ' - ä½™é¢' + selectedPerson.total_points + 'åˆ†' : 'è¯·é€‰æ‹©äººå‘˜'}}
        </view>
      </picker>
    </view>

    <view class="balance-display" wx:if="{{selectedPerson}}">
      <text class="balance-label">å½“å‰å¯ç”¨ç§¯åˆ†</text>
      <text class="balance-value">{{selectedPerson.total_points}}åˆ†</text>
    </view>
  </view>

  <!-- å•†å“é€‰æ‹©åŒº -->
  <view class="section" wx:if="{{selectedPerson}}">
    <view class="section-title">2. é€‰æ‹©å•†å“</view>
    
    <view class="product-grid">
      <view class="product-item {{item.selected ? 'selected' : ''}} {{item.stock_quantity === 0 ? 'out-of-stock' : ''}}" 
            wx:for="{{products}}" 
            wx:key="id"
            bindtap="selectProduct"
            data-id="{{item.id}}">
        <view class="product-icon">ğŸ</view>
        <text class="product-name">{{item.name}}</text>
        <text class="product-points">{{item.points_price}}åˆ†/{{item.unit}}</text>
        <text class="product-stock">åº“å­˜ï¼š{{item.stock_quantity}}</text>
        <view class="quantity-control" wx:if="{{item.selected}}" catchtap="stopPropagation">
          <text class="btn-minus" catchtap="changeQuantity" data-id="{{item.id}}" data-delta="-1">-</text>
          <text class="quantity">{{cart[item.id] || 0}}</text>
          <text class="btn-plus" catchtap="changeQuantity" data-id="{{item.id}}" data-delta="1">+</text>
        </view>
        <view class="out-of-stock-tag" wx:if="{{item.stock_quantity === 0}}">ç¼ºè´§</view>
      </view>
    </view>
  </view>

  <!-- è´­ç‰©è½¦æ±‡æ€» -->
  <view class="cart-summary" wx:if="{{totalPoints > 0}}">
    <view class="summary-row">
      <text class="label">å·²é€‰å•†å“ï¼š</text>
      <text class="value">{{selectedCount}}ç§</text>
    </view>
    <view class="summary-row">
      <text class="label">æ€»è®¡ç§¯åˆ†ï¼š</text>
      <text class="value total">{{totalPoints}}åˆ†</text>
    </view>
    <view class="summary-row" wx:if="{{selectedPerson}}">
      <text class="label">å…‘æ¢åä½™é¢ï¼š</text>
      <text class="value {{selectedPerson.total_points - totalPoints < 0 ? 'insufficient' : ''}}">
        {{selectedPerson.total_points - totalPoints}}åˆ†
      </text>
    </view>
    <view class="warning" wx:if="{{selectedPerson && selectedPerson.total_points < totalPoints}}">
      ç§¯åˆ†ä¸è¶³ï¼Œæ— æ³•å…‘æ¢
    </view>
  </view>

  <button class="submit-btn" 
          bindtap="submitExchange" 
          disabled="{{!canSubmit}}"
          style="background: {{canSubmit ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : '#ccc'}}">
    {{selectedPerson && selectedPerson.total_points < totalPoints ? 'ç§¯åˆ†ä¸è¶³' : 'ç¡®è®¤å…‘æ¢'}}
  </button>
</view>
